# 修仙游戏长期养成系统 - 技术规范

> **Generated by Autopilot Workflow:** Analyst → Architect
> **Created:** 2026-02-12
> **Target:** 1000小时在线养成 + 1000天离线养成

---

## 1. 需求分析摘要 (Analyst Output)

### 1.1 功能需求

| 需求 | 描述 | 优先级 |
|------|------|--------|
| 离线成长系统 | 玩家离线时自动积累XP、灵石、修为 | P0 |
| 里程碑追踪 | 13境界突破、等级、游戏时间里程碑 | P0 |
| 每日活动追踪 | 登录连续天数、每日奖励 | P1 |
| 回归玩家加速 | 长期离线玩家的追赶机制 | P1 |
| 时间曲线可视化 | 显示进度百分比和完成时间估算 | P2 |

### 1.2 关键假设

- **目标玩家行为**: 1-2小时/天，持续1-3年
- **离线成长率**: 在线效率的20%（可配置10-30%）
- **最大离线积累**: 14天（336小时）
- **激活条件**: Level 10+ 或 10小时游戏时间

### 1.3 边界条件

| 场景 | 处理方式 |
|------|----------|
| 新账号离线3年 | 无离线奖励（未达激活条件） |
| 满级玩家离线 | 转化为声望货币或外观奖励 |
| 服务器停机 | 不计入离线时间，考虑补偿 |
| 时区/夏令时 | 仅使用服务器时间戳 |

---

## 2. 架构设计 (Architect Output)

### 2.1 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Long-term Progression Architecture           │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │   Web Layer     │    │   Scheduler     │                    │
│  │ offline_routes  │───▶│ (APScheduler)   │                    │
│  └────────┬────────┘    └────────┬────────┘                    │
│           ▼                      ▼                              │
│  ┌─────────────────────────────────────────┐                   │
│  │           Service Layer                  │                   │
│  │ • OfflineGrowthCalculator               │                   │
│  │ • ProgressionMilestoneTracker           │                   │
│  │ • DailyActivityTracker                  │                   │
│  │ • CatchUpMechanics                      │                   │
│  └────────────────┬────────────────────────┘                   │
│                   ▼                                             │
│  ┌─────────────────────────────────────────┐                   │
│  │           Data Layer                     │                   │
│  │ • Player (extended)                      │                   │
│  │ • OfflineAccumulation (new)             │                   │
│  │ • DailyActivityLog (new)                │                   │
│  └─────────────────────────────────────────┘                   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 文件结构

**新建文件:**
```
src/progression/
├── __init__.py
├── offline_growth.py      # OfflineGrowthCalculator
├── milestone.py           # ProgressionMilestoneTracker
├── daily_activity.py      # DailyActivityTracker
├── catch_up.py            # CatchUpMechanics
└── time_curve.py          # TimeCurveCalculator

src/web/
└── offline_routes.py      # 离线/进度API

config/progression/
├── offline_growth.yaml    # 离线成长配置
├── milestones.yaml        # 里程碑定义
└── time_curve.yaml        # 时间曲线配置

migrations/
└── 003_offline_progression.py
```

**修改文件:**
- src/models/player.py - 添加离线追踪字段
- src/data/sqlite_storage.py - 新表方法
- src/web/simple_app.py - 注册新蓝图
- config/settings.yaml - 进度配置

---

## 3. 核心模块设计

### 3.1 OfflineGrowthCalculator

**功能**: 计算玩家离线期间的成长奖励

**核心参数:**
```yaml
growth_rate_percentage: 0.20    # 20%在线效率
max_accumulation_hours: 336     # 14天上限
min_accumulation_hours: 1       # 最少1小时
activation_requirements:
  min_level: 10
  min_playtime_hours: 10
  require_any: true             # 满足其一即可

reward_sources:
  meditation:
    xp_per_hour: 5
    stones_per_hour: 2
  sect_allowance:
    stones_per_hour: 1
    cultivation_per_hour: 1
    requires_sect: true
  passive_cultivation:
    xp_per_hour: 3
    cultivation_per_hour: 2
```

**境界倍率:**
| 境界 | 倍率 |
|------|------|
| 炼气期 | 1.0x |
| 筑基期 | 1.2x |
| 金丹期 | 1.5x |
| 元婴期 | 1.8x |
| 元神期 | 2.0x |
| 化神期 | 2.5x |
| 炼虚期 | 3.0x |
| 合体期 | 3.5x |
| 大乘期 | 4.0x |
| 渡劫期 | 5.0x |
| 真仙境 | 6.0x |
| 金仙境 | 8.0x |
| 太乙境 | 10.0x |
| 大罗境 | 12.0x |

### 3.2 ProgressionMilestoneTracker

**里程碑类型:**
- REALM: 境界突破
- LEVEL: 等级里程碑 (100, 500, 1000, 2000, 5000)
- PLAYTIME: 游戏时间 (10h, 50h, 100h, 500h, 1000h)
- COMBAT: 战斗次数 (100, 1000, 10000)

### 3.3 DailyActivityTracker

**连续登录奖励:**
| 天数 | 灵石 | 流派点 | 称号 |
|------|------|--------|------|
| 7 | 1,000 | 5 | - |
| 30 | 5,000 | 20 | 月度修士 |
| 100 | 20,000 | 50 | 百日道友 |
| 365 | 100,000 | 100 | 年度真修 |
| 1000 | 1,000,000 | 500 | 千年仙人 |

**宽限期:** 2-3天不掉断连击，仅-1

### 3.4 CatchUpMechanics

**回归玩家加速:**
| 离线天数 | 等级 | XP倍率 | 持续 | 即时奖励 |
|----------|------|--------|------|----------|
| 7-14 | LIGHT | 1.25x | 3天 | 10K XP |
| 14-30 | MODERATE | 1.5x | 7天 | 50K XP |
| 30-90 | HEAVY | 2.0x | 14天 | 200K XP |
| 90+ | EXTREME | 3.0x | 30天 | 1M XP |

---

## 4. 时间曲线设计 (13境界)

### 4.1 在线/离线时间分配

| 境界 | 等级范围 | 在线小时 | 累计在线 | 离线天数 | 累计离线 |
|------|----------|----------|----------|----------|----------|
| 炼气期 | 1-99 | 20 | 20 | 10 | 10 |
| 筑基期 | 100-199 | 40 | 60 | 15 | 25 |
| 金丹期 | 200-299 | 80 | 140 | 25 | 50 |
| 元婴期 | 300-499 | 120 | 260 | 40 | 90 |
| 元神期 | 500-999 | 100 | 360 | 50 | 140 |
| 化神期 | 1000-1499 | 100 | 460 | 60 | 200 |
| 炼虚期 | 1500-1999 | 120 | 580 | 70 | 270 |
| 合体期 | 2000-2499 | 140 | 720 | 80 | 350 |
| 大乘期 | 2500-2999 | 80 | 800 | 90 | 440 |
| 渡劫期 | 3000-3499 | 60 | 860 | 100 | 540 |
| 真仙境 | 3500-3999 | 50 | 910 | 120 | 660 |
| 金仙境 | 4000-4499 | 30 | 940 | 140 | 800 |
| 太乙境 | 4500-4999 | 20 | 960 | 160 | 960 |
| 大罗境 | 5000+ | 40 | 1000 | 200 | 1160 |

**总计:** ~1000在线小时, ~1000离线天

---

## 5. API设计

```
GET  /api/offline/rewards        # 获取待领取的离线奖励
POST /api/offline/rewards/claim  # 领取离线奖励
GET  /api/offline/milestones     # 获取里程碑进度
POST /api/offline/milestones/<id>/claim  # 领取里程碑奖励
GET  /api/offline/streak         # 获取登录连续信息
GET  /api/offline/catch-up       # 获取回归玩家加速状态
GET  /api/offline/progress       # 获取整体进度信息
```

---

## 6. 验收标准

1. [ ] 离线7天后，玩家获得相当于在线1.4小时的奖励（20%效率）
2. [ ] 离线15天后，仅前14天计入，第15天无额外奖励
3. [ ] Level 5玩家离线无奖励（未达Level 10激活条件）
4. [ ] 连续登录30天可领取"月度修士"称号
5. [ ] 离线30天回归玩家获得14天2.0x XP加成
6. [ ] 进度API返回准确的完成时间估算
7. [ ] 所有里程碑奖励可领取且不可重复领取

---

**EXPANSION_COMPLETE**
