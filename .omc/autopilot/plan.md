# 修仙游戏长期养成系统 - 实施计划

> **Generated by Autopilot Workflow:** Architect → Critic → Approved
> **Created:** 2026-02-12
> **Total Estimate:** 36-46 hours

---

## 项目概览

### 目标
- 实现 1000 小时在线养成 + 1000 天离线养成系统
- 支持 13 境界的时间曲线分配
- 提供完整的里程碑追踪、每日活动、回归玩家加速机制

### 总体时间估算
| 阶段 | 估算时间 |
|------|----------|
| P0 核心系统 (离线成长 + 里程碑) | 16-20 小时 |
| P1 辅助系统 (每日活动 + 回归加速) | 10-12 小时 |
| P2 可视化 (时间曲线) | 4-6 小时 |
| 测试与集成 | 6-8 小时 |
| **总计** | **36-46 小时** |

---

## Phase 1: P0 - 离线成长系统

### Task 1.1: 离线成长配置
**复杂度**: S (2-3小时) | **依赖**: 无 | **优先级**: P0-Critical

**任务清单**:
- [ ] 创建 `config/progression/` 目录
- [ ] 创建 `config/progression/offline_growth.yaml`
- [ ] 定义全部 14 境界倍率
- [ ] 定义奖励来源配置

**验收标准**:
- YAML 配置可被正确加载
- 缺少配置时使用合理默认值

**文件清单**:
```
新建:
- config/progression/offline_growth.yaml
```

---

### Task 1.2: OfflineGrowthCalculator 核心实现
**复杂度**: M (5-6小时) | **依赖**: Task 1.1 | **优先级**: P0-Critical

**任务清单**:
- [ ] 创建 `src/progression/__init__.py`
- [ ] 创建 `src/progression/offline_growth.py`
- [ ] 实现 `OfflineGrowthCalculator` 类
- [ ] 添加完整类型注解

**验收标准**:
- 离线 7 天玩家获得相当于在线 1.4 小时奖励 (20% 效率)
- 离线 15 天仅前 14 天计入
- Level 5 玩家离线无奖励

**文件清单**:
```
新建:
- src/progression/__init__.py
- src/progression/offline_growth.py
```

---

### Task 1.3: Player 模型扩展
**复杂度**: S (1-2小时) | **依赖**: Task 1.2 | **优先级**: P0-Critical

**新增字段**:
```python
# src/models/player.py - 添加到 Player dataclass
last_offline_claim: Optional[datetime] = None
total_playtime_hours: float = 0.0
offline_rewards_pending: Dict[str, Any] = field(default_factory=dict)
login_streak: int = 0
last_streak_date: Optional[str] = None  # ISO date string
catch_up_bonus: Dict[str, Any] = field(default_factory=lambda: {
    "tier": "none",
    "expires_at": None,
    "instant_claimed": False,
})
total_combats: int = 0
```

**验收标准**:
- Player 实例可正确序列化/反序列化新字段
- 现有存档数据兼容 (新字段有默认值)

**文件清单**:
```
修改:
- src/models/player.py (添加字段，约 line 62-106)
```

---

### Task 1.4: 数据库迁移
**复杂度**: S (2小时) | **依赖**: Task 1.3 | **优先级**: P0-Critical

**Schema**:
```sql
CREATE TABLE offline_accumulations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    player_id TEXT NOT NULL,
    logout_time TIMESTAMP NOT NULL,
    login_time TIMESTAMP,
    accumulated_hours REAL DEFAULT 0,
    xp_accumulated INTEGER DEFAULT 0,
    stones_accumulated INTEGER DEFAULT 0,
    cultivation_accumulated INTEGER DEFAULT 0,
    claimed INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (player_id) REFERENCES players(player_id)
);

CREATE INDEX idx_offline_player ON offline_accumulations(player_id);

CREATE TABLE daily_activity_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    player_id TEXT NOT NULL,
    activity_date DATE NOT NULL,
    login_count INTEGER DEFAULT 1,
    playtime_minutes INTEGER DEFAULT 0,
    streak_day INTEGER DEFAULT 1,
    rewards_claimed INTEGER DEFAULT 0,
    UNIQUE(player_id, activity_date)
);

CREATE INDEX idx_daily_player_date ON daily_activity_logs(player_id, activity_date);
```

**文件清单**:
```
新建:
- migrations/003_offline_progression.py

修改:
- src/data/sqlite_storage.py (添加表创建逻辑，约 line 45-83)
```

---

## Phase 2: P0 - 里程碑追踪系统

### Task 2.1: 里程碑配置
**复杂度**: S (1-2小时) | **依赖**: 无 | **优先级**: P0-Critical

**文件清单**:
```
新建:
- config/progression/milestones.yaml
```

---

### Task 2.2: ProgressionMilestoneTracker 实现
**复杂度**: M (4-5小时) | **依赖**: Task 2.1 | **优先级**: P0-Critical

**文件清单**:
```
新建:
- src/progression/milestone.py
```

---

## Phase 3: P1 - 每日活动追踪

### Task 3.1: DailyActivityTracker 实现
**复杂度**: M (4-5小时) | **依赖**: Phase 1 | **优先级**: P1-High

**验收标准**:
- 连续登录 30 天可领取 "月度修士" 称号
- 宽限期 2-3 天不断连击

**文件清单**:
```
新建:
- src/progression/daily_activity.py
```

---

## Phase 4: P1 - 回归玩家加速

### Task 4.1: CatchUpMechanics 实现
**复杂度**: M (3-4小时) | **依赖**: Phase 1 | **优先级**: P1-High

**验收标准**:
- 离线 30 天回归玩家获得 14 天 2.0x XP 加成
- 加成到期自动失效

**文件清单**:
```
新建:
- src/progression/catch_up.py
```

---

## Phase 5: P2 - 时间曲线可视化

### Task 5.1: TimeCurveCalculator 实现
**复杂度**: S (2-3小时) | **依赖**: Phase 1, 2 | **优先级**: P2-Medium

**文件清单**:
```
新建:
- config/progression/time_curve.yaml
- src/progression/time_curve.py
```

---

## Phase 6: API 与集成

### Task 6.1: 离线/进度 API 路由
**复杂度**: M (3-4小时) | **依赖**: Phase 1-5 | **优先级**: P0-Critical

**API 端点**:
```
GET  /api/offline/rewards        # 获取待领取奖励
POST /api/offline/rewards/claim  # 领取奖励
GET  /api/offline/milestones     # 里程碑进度
POST /api/offline/milestones/<id>/claim  # 领取里程碑
GET  /api/offline/streak         # 登录连续信息
GET  /api/offline/catch-up       # 回归加速状态
GET  /api/offline/progress       # 整体进度
```

**文件清单**:
```
新建:
- src/web/offline_routes.py

修改:
- src/web/simple_app.py (注册蓝图，约 line 39-44)
```

---

### Task 6.2: 登录集成
**复杂度**: S (1小时) | **依赖**: Task 6.1 | **优先级**: P0-Critical

**集成点**: `src/web/simple_app.py` login_player() 函数 (约 line 191-258)

**修改逻辑**:
```python
# 在 session['player_name'] = name 之后添加:
from src.progression.offline_growth import OfflineGrowthCalculator
calc = OfflineGrowthCalculator()
offline_result = calc.calculate_offline_rewards(player_data)

if offline_result['has_rewards']:
    player_data['offline_rewards_pending'] = offline_result
    get_storage().save(player_data['player_id'], player_data)
```

---

## Phase 7: 测试

### Task 7.1: 单元测试
**复杂度**: M (3-4小时) | **依赖**: Phase 1-6 | **优先级**: P1-High

**文件清单**:
```
新建:
- tests/test_progression/__init__.py
- tests/test_progression/test_offline_growth.py
- tests/test_progression/test_milestone.py
- tests/test_progression/test_daily_activity.py
- tests/test_progression/test_catch_up.py
- tests/test_progression/test_time_curve.py
```

---

## 依赖关系图

```
Task 1.1 (配置) ──► Task 1.2 (Calculator) ──► Task 1.3 (Player) ──► Task 1.4 (DB)
                                                           │
Task 2.1 (里程碑配置) ──► Task 2.2 (里程碑实现) ─────────────┤
                                                           │
Task 3.1 (每日活动) ◄───────────────────────────────────────┤
                                                           │
Task 4.1 (回归加速) ◄───────────────────────────────────────┤
                                                           │
Task 5.1 (时间曲线) ◄───────────────────────────────────────┤
                                                           │
                    Task 6.1 (API) ◄────────────────────────┘
                           │
                    Task 6.2 (登录集成)
                           │
                    Task 7.1 (测试)
```

---

## 文件清单汇总

### 新建文件 (13个)
1. `config/progression/offline_growth.yaml`
2. `config/progression/milestones.yaml`
3. `config/progression/time_curve.yaml`
4. `src/progression/__init__.py`
5. `src/progression/offline_growth.py`
6. `src/progression/milestone.py`
7. `src/progression/daily_activity.py`
8. `src/progression/catch_up.py`
9. `src/progression/time_curve.py`
10. `src/web/offline_routes.py`
11. `migrations/003_offline_progression.py`
12. `tests/test_progression/__init__.py`
13. `tests/test_progression/test_*.py` (5个测试文件)

### 修改文件 (4个)
1. `src/models/player.py` - 添加离线追踪字段
2. `src/data/sqlite_storage.py` - 添加新表方法
3. `src/web/simple_app.py` - 注册蓝图、登录集成
4. `config/settings.yaml` - 添加进度系统配置引用

---

## 验收标准检查清单

| # | 验收标准 | 测试用例 |
|---|----------|----------|
| 1 | 离线7天获得1.4小时等效奖励 | `test_offline_growth.py::test_7day_offline` |
| 2 | 离线15天仅14天计入 | `test_offline_growth.py::test_15day_cap` |
| 3 | Level 5无奖励 | `test_offline_growth.py::test_activation_level` |
| 4 | 30天连续登录得称号 | `test_daily_activity.py::test_30day_streak` |
| 5 | 30天回归得2.0x加成 | `test_catch_up.py::test_returning_player` |
| 6 | 进度API准确估算 | `test_time_curve.py::test_progress_estimation` |
| 7 | 里程碑不可重复领取 | `test_milestone.py::test_claim_once` |

---

**PLANNING_COMPLETE**
