# ä¿®ä»™æ¸¸æˆå¼€å‘ä»»åŠ¡ Issues Backlog

> **Generated by ralplan workflow:** Planner â†’ Architect â†’ Critic (2026-02-11)
> **Last Updated:** 2026-02-12
> **Plan File:** `.omc/plans/game-improvements-plan.md`

---

## ğŸ”´ Phase 0: Critical Bug Fixes (Must Complete First) âœ… COMPLETED

### Issue #0.1: ä¿®å¤é‡å¤çš„é—¨æ´¾æ•°æ® âœ…
**Priority:** P0 (Blocking)
**Type:** Bug
**Estimate:** S (1-2 hours)
**Status:** COMPLETED (2026-02-12)

**Problem:**
- `SECT_ADVANTAGES` å­˜åœ¨äºä¸¤ä¸ªæ–‡ä»¶ä¸­ä¸”æ•°æ®ä¸åŒ
- `player.py:360-372` æœ‰ 11 æ¡è®°å½•
- `sect.py:99-104` æœ‰ 4 æ¡è®°å½•ï¼ˆæ—§æ•°æ®ï¼‰

**Tasks:**
- [x] å°†æ‰€æœ‰é—¨æ´¾æ•°æ®åˆå¹¶åˆ° `player.py`
- [x] æ›´æ–° `sect.py` ä» `player.py` å¯¼å…¥æˆ–åˆ é™¤é‡å¤å®šä¹‰
- [x] éªŒè¯æ— å¯¼å…¥é”™è¯¯

**Files:** `src/models/player.py`, `src/models/sect.py`

---

### Issue #0.2: è¡¥å…¨ sect.py ç¼ºå¤±çš„é—¨æ´¾ âœ…
**Priority:** P0 (Blocking)
**Type:** Bug
**Estimate:** S (1 hour)
**Status:** COMPLETED (2026-02-12)

**Problem:**
- `sect.py:20-96` åªå®šä¹‰äº† 5 ä¸ªé—¨æ´¾
- ç¼ºå¤±: KUNLUN, YINYIN, XUEMO

**Tasks:**
- [x] åœ¨ `sect.py` ä¸­æ·»åŠ ç¼ºå¤±çš„ 3 ä¸ªé—¨æ´¾å®šä¹‰
- [x] æˆ–åˆ é™¤é‡å¤ï¼Œæ”¹ä¸ºä» `player.py` å¯¼å…¥
- [x] éªŒè¯æ‰€æœ‰ 8 ä¸ªé—¨æ´¾å¯è®¿é—®

**Files:** `src/models/sect.py`

---

### Issue #0.3: ä¿®å¤ç©å®¶åˆ›å»ºåªèƒ½é€‰ 5 ä¸ªé—¨æ´¾ âœ…
**Priority:** P0 (Blocking)
**Type:** Bug
**Estimate:** S (30 min)
**Status:** COMPLETED (2026-02-12)

**Problem:**
- `simple_app.py:88-94` çš„ `sect_mapping` åªæœ‰ 5 ä¸ªé—¨æ´¾
- ç©å®¶æ— æ³•åŠ å…¥ KUNLUN, YINYIN, XUEMO

**Tasks:**
- [ ] æ·»åŠ  `'kunlun': SectType.KUNLUN`
- [ ] æ·»åŠ  `'yinyin': SectType.YINYIN`
- [ ] æ·»åŠ  `'xuemo': SectType.XUEMO`
- [ ] æµ‹è¯•ç©å®¶åˆ›å»ºæµç¨‹

**Files:** `src/web/simple_app.py`

---

### Issue #0.4: CombatSession æ·»åŠ ç©å®¶å…³è”å­—æ®µ âœ…
**Priority:** P0 (Required for Task 5)
**Type:** Architecture
**Estimate:** S (1 hour)
**Status:** COMPLETED (2026-02-12)

**Problem:**
- `CombatSession` æœ‰ `player: CombatEntity` ä½†æ—  `player_name`
- æ— æ³•æŒä¹…åŒ–åæ¢å¤ä¼šè¯

**Tasks:**
- [x] åœ¨ `CombatSession` dataclass æ·»åŠ  `player_name: str` å­—æ®µ
- [x] æ›´æ–°ä¼šè¯åˆ›å»ºé€»è¾‘è®¾ç½® player_name
- [x] æ›´æ–°ç›¸å…³æµ‹è¯•

**Files:** `src/web/combat_routes.py`

---

## ğŸŸ¡ Phase 1: Foundation (Week 1)

### Issue #1: æµæ´¾æ•°æ®å¤–ç½®åˆ° YAML
**Priority:** P1 (High)
**Type:** Feature
**Estimate:** M (2-3 days)
**Dependencies:** Phase 0 complete

**Subtasks:**
| # | Task | Est. |
|---|------|------|
| 1.1 | åˆ›å»º 40 æµæ´¾çš„ YAML schema | S |
| 1.2 | è¿ç§»æ‰€æœ‰ 40 ä¸ªæµæ´¾åˆ° `config/schools.yaml` | M |
| 1.3 | åˆ›å»º SchoolConfigLoader ç±» | S |
| 1.4 | æ›´æ–° `school.py` ä½¿ç”¨ loader | S |
| 1.5 | æ·»åŠ å¿…å¡«å­—æ®µéªŒè¯ | S |

**Files to Create:**
- `config/schools.yaml`

**Files to Modify:**
- `src/models/school.py`

**Acceptance Criteria:**
- [ ] æ‰€æœ‰ 40 ä¸ªæµæ´¾ä» `config/schools.yaml` æ­£ç¡®åŠ è½½
- [ ] ç¼ºå¤±å­—æ®µåœ¨å¯åŠ¨æ—¶æŠ¥é”™
- [ ] ç°æœ‰åŠŸèƒ½ä¸å—å½±å“

---

### Issue #2: å®Œå–„é—¨æ´¾å…‹åˆ¶å…³ç³»
**Priority:** P1 (High)
**Type:** Feature
**Estimate:** S (1 day)
**Dependencies:** Issue #0.1

**Subtasks:**
| # | Task | Est. |
|---|------|------|
| 2.1 | è®¾è®¡å®Œæ•´çš„ 8x8 å…‹åˆ¶çŸ©é˜µ | S |
| 2.2 | å®ç°çŸ³å¤´å‰ªåˆ€å¸ƒé€»è¾‘ | S |
| 2.3 | æ·»åŠ å…‹åˆ¶å…³ç³»æ–‡æ¡£æ³¨é‡Š | S |
| 2.4 | åŒæ­¥æ›´æ–° SECT_ADVANTAGES | S |
| 2.5 | æ·»åŠ  `get_sect_counter_info()` è¾…åŠ©å‡½æ•° | S |

**Files to Modify:**
- `src/models/player.py`
- `src/models/sect.py`

**Counter Matrix Design:**
```
é’äº‘é—¨(é£) â†’ å…‹: ä¸‡èŠ±è°·, é€é¥å®— | è¢«å…‹: èœ€å±±æ´¾, æ˜†ä»‘æ´¾
ä¸¹é¼é—¨(ç«) â†’ å…‹: æ˜†ä»‘æ´¾, èœ€å±±æ´¾ | è¢«å…‹: ä¸‡èŠ±è°·, é€é¥å®—
ä¸‡èŠ±è°·(æœ¨) â†’ å…‹: é€é¥å®—, è¡€é­”å®— | è¢«å…‹: é’äº‘é—¨, ä¸¹é¼é—¨
é€é¥å®—(è™š) â†’ å…‹: ä¸¹é¼é—¨, æ˜†ä»‘æ´¾ | è¢«å…‹: ä¸‡èŠ±è°·, å¹»éŸ³åŠ
èœ€å±±æ´¾(é›·) â†’ å…‹: é’äº‘é—¨, å¹»éŸ³åŠ | è¢«å…‹: ä¸¹é¼é—¨, è¡€é­”å®—
æ˜†ä»‘æ´¾(å†°) â†’ å…‹: é’äº‘é—¨, å¹»éŸ³åŠ | è¢«å…‹: ä¸¹é¼é—¨, é€é¥å®—
å¹»éŸ³åŠ(éŸ³) â†’ å…‹: é€é¥å®—, è¡€é­”å®— | è¢«å…‹: èœ€å±±æ´¾, æ˜†ä»‘æ´¾
è¡€é­”å®—(è¡€) â†’ å…‹: èœ€å±±æ´¾, ä¸¹é¼é—¨ | è¢«å…‹: ä¸‡èŠ±è°·, å¹»éŸ³åŠ
```

---

## ğŸŸ¡ Phase 2: Core Features (Week 2)

### Issue #3: æ·»åŠ æµæ´¾è¿›åº¦ç³»ç»Ÿ
**Priority:** P1 (High)
**Type:** Feature
**Estimate:** M (2-3 days)
**Dependencies:** Issue #1

**Subtasks:**
| # | Task | Est. |
|---|------|------|
| 3.1 | æ‰©å±• SchoolProgress dataclass | S |
| 3.2 | åˆ›å»º SchoolProgressManager ç±» | M |
| 3.3 | æ·»åŠ æµæ´¾ç‚¹æ•°è·å–é€»è¾‘ | S |
| 3.4 | å®ç°æŠ€èƒ½è§£é”æ ‘ | M |
| 3.5 | æ·»åŠ ç²¾é€šç­‰çº§åŠ æˆ | S |
| 3.6 | åˆ›å»ºè¿›åº¦ API ç«¯ç‚¹ | S |
| 3.7 | æŒä¹…åŒ–è¿›åº¦åˆ°å­˜å‚¨ | S |

**Note:** `SchoolProgress` å·²å­˜åœ¨äº `school.py:76-81`ï¼Œéœ€è¦æ‰©å±•è€Œéåˆ›å»ºæ–°æ–‡ä»¶

**Files to Modify:**
- `src/models/school.py` (æ‰©å±• SchoolProgress)
- `src/models/player.py` (æ·»åŠ  school_progress å­—æ®µ)
- `src/data/simple_storage.py` (æŒä¹…åŒ–)
- `src/game/game_systems.py` (ç‚¹æ•°è·å–)
- `src/web/simple_app.py` (API ç«¯ç‚¹)

---

### Issue #4: æ•°æ®åº“å­˜å‚¨å±‚
**Priority:** P2 (Medium)
**Type:** Architecture
**Estimate:** L (3-4 days)
**Dependencies:** None

**Subtasks:**
| # | Task | Est. |
|---|------|------|
| 4.1 | è®¾è®¡ PlayerStorageInterface æŠ½è±¡ç±» | S |
| 4.2 | åˆ›å»º SQLite schema | S |
| 4.3 | å®ç° SQLiteStorage | M |
| 4.4 | é‡æ„ JSONStorage å®ç°æ¥å£ | S |
| 4.5 | åˆ›å»º StorageFactory | S |
| 4.6 | æ·»åŠ è¿ç§»è„šæœ¬ | M |
| 4.7 | æ›´æ–°æ‰€æœ‰å­˜å‚¨æ¶ˆè´¹è€… | S |

**Files to Create:**
- `src/data/storage_interface.py`
- `src/data/sqlite_storage.py`
- `src/data/storage_factory.py`
- `migrations/schema.sql`

**Files to Modify:**
- `src/data/simple_storage.py` â†’ é‡å‘½åä¸º `json_storage.py`
- `src/web/simple_app.py`
- `config/settings.yaml`

**Schema Notes:**
- SQLite ä½¿ç”¨ TEXT è€Œé JSON ç±»å‹
- æ·»åŠ  schema_version è¡¨ç”¨äºè¿ç§»è¿½è¸ª
- è¿ç§»è„šæœ¬éœ€åŒ…å« downgrade æ–¹æ³•

---

## ğŸŸ¡ Phase 3: Enhancement (Week 3)

### Issue #5: æˆ˜æ–—ç³»ç»ŸæŒä¹…åŒ–
**Priority:** P2 (Medium)
**Type:** Feature
**Estimate:** M (2 days)
**Dependencies:** Issue #0.4, Issue #4

**Subtasks:**
| # | Task | Est. |
|---|------|------|
| 5.1 | åˆ›å»º CombatSessionSerializer | S |
| 5.2 | æ·»åŠ  combat_sessions è¡¨ | S |
| 5.3 | æ¯æ¬¡æ“ä½œåä¿å­˜ä¼šè¯ | S |
| 5.4 | å®ç°ä¼šè¯æ¢å¤ | M |
| 5.5 | æ·»åŠ æˆ˜æ–—æ—¥å¿—æŒä¹…åŒ– | S |
| 5.6 | æ·»åŠ ä¼šè¯è¿‡æœŸæ¸…ç† | S |
| 5.7 | åˆ›å»ºé‡è¿ API | S |

**Note:** `CombatSession` å·²åœ¨ `combat_routes.py:76-97`ï¼Œåœ¨ç°æœ‰æ¨¡å—æ·»åŠ æ–¹æ³•

**Files to Modify:**
- `src/web/combat_routes.py`

**Files to Create:**
- `src/combat/persistence.py` (åºåˆ—åŒ–å™¨)

---

### Issue #6: ç»éªŒæ›²çº¿ä¼˜åŒ–
**Priority:** P2 (Medium)
**Type:** Feature
**Estimate:** M (2 days)
**Dependencies:** None

**Subtasks:**
| # | Task | Est. |
|---|------|------|
| 6.1 | åˆ›å»º ExperienceCalculator ç±» | S |
| 6.2 | å®ç° XP åŠ æˆç³»ç»Ÿ | S |
| 6.3 | æ·»åŠ çªç ´æŒ‘æˆ˜ | M |
| 6.4 | å¯é…ç½®çš„ XP æ›²çº¿è°ƒæ•´ | S |
| 6.5 | æ·»åŠ ä¼‘æ¯ XP åŠ æˆ | S |
| 6.6 | åˆ›å»º XP æ˜ç»†æ˜¾ç¤º | S |
| 6.7 | æ·»åŠ ç­‰çº§åŒæ­¥æœºåˆ¶ | S |

**Files to Create:**
- `src/game/experience.py`

**Files to Modify:**
- `src/game/game_systems.py`
- `src/models/player.py`
- `config/settings.yaml`

**Note:** éœ€è¦æ›´æ–° `last_active` æ—¶é—´æˆ³ï¼ˆ`player.py:85` å·²æœ‰å­—æ®µä½†æœªä½¿ç”¨ï¼‰

---

## ğŸŸ¢ Phase 4: Quality (Week 4)

### Issue #7: æ·»åŠ æµ‹è¯•è¦†ç›–
**Priority:** P3 (Low)
**Type:** Quality
**Estimate:** M (2-3 days)
**Dependencies:** None

**Subtasks:**
| # | Task | Est. |
|---|------|------|
| 7.1 | é…ç½® pytest ç¯å¢ƒ | S |
| 7.2 | æˆ˜æ–—ç³»ç»Ÿæµ‹è¯• | M |
| 7.3 | è£…å¤‡ç”Ÿæˆæµ‹è¯• | M |
| 7.4 | ä¼¤å®³è®¡ç®—æµ‹è¯• | M |
| 7.5 | æµæ´¾ç³»ç»Ÿæµ‹è¯• | S |
| 7.6 | å­˜å‚¨å±‚æµ‹è¯• | S |
| 7.7 | è¾¾åˆ° 70%+ è¦†ç›–ç‡ | S |

**Note:** `tests/` ç›®å½•å·²å­˜åœ¨ï¼Œæ‰©å±•ç°æœ‰ç»“æ„

**Files to Create:**
- `tests/conftest.py`
- `tests/test_combat.py`
- `tests/test_equipment.py`
- `tests/test_damage.py`
- `tests/test_schools.py`
- `tests/test_storage.py`
- `tests/fixtures/`

---

### Issue #8: API æ–‡æ¡£
**Priority:** P3 (Low)
**Type:** Documentation
**Estimate:** S (1 day)
**Dependencies:** None

**Subtasks:**
| # | Task | Est. |
|---|------|------|
| 8.1 | å®‰è£… flasgger | S |
| 8.2 | ä¸ºæ‰€æœ‰è·¯ç”±æ·»åŠ  docstring | M |
| 8.3 | é…ç½® Swagger UI | S |
| 8.4 | æ·»åŠ è¯·æ±‚/å“åº” schema | S |
| 8.5 | ç”Ÿæˆé™æ€æ–‡æ¡£ | S |

**Files to Create:**
- `src/web/swagger.py`
- `docs/api/`

**Files to Modify:**
- `src/web/simple_app.py`
- `src/web/combat_routes.py`
- `requirements.txt`

---

## Dependency Graph

```
Phase 0 (Critical Bugs)
    â”‚
    â”œâ”€â†’ Issue #0.1 â”€â†’ Issue #2
    â”œâ”€â†’ Issue #0.2 â”€â†’ Issue #2
    â”œâ”€â†’ Issue #0.3
    â””â”€â†’ Issue #0.4 â”€â†’ Issue #5

Phase 1-2 (Features)
    â”‚
    â”œâ”€â†’ Issue #1 â”€â†’ Issue #3
    â”œâ”€â†’ Issue #2 (standalone)
    â””â”€â†’ Issue #4 â”€â†’ Issue #5

Phase 3-4 (Enhancement & Quality)
    â”‚
    â”œâ”€â†’ Issue #5
    â”œâ”€â†’ Issue #6 (standalone)
    â”œâ”€â†’ Issue #7 (standalone)
    â””â”€â†’ Issue #8 (standalone)
```

---

## Summary

| Phase | Issues | Estimate | Status |
|-------|--------|----------|--------|
| Phase 0 | 4 critical bugs | ~5 hours | âœ… COMPLETED |
| Phase 1 | #1, #2 | ~4 days | Pending |
| Phase 2 | #3, #4 | ~5 days | Pending |
| Phase 3 | #5, #6 | ~4 days | Pending |
| Phase 4 | #7, #8 | ~3 days | Pending |

**Total Estimate:** ~4 weeks (including bug fixes)

---

## ğŸ†• Newly Implemented Features (2026-02-12)

### âœ… é•¿æœŸå…»æˆç³»ç»Ÿ (1000å°æ—¶åœ¨çº¿ / 1000å¤©ç¦»çº¿)

**Status:** COMPLETED
**Implementation Date:** 2026-02-12

**Features Implemented:**
1. **ç¦»çº¿æˆé•¿ç³»ç»Ÿ** - ç©å®¶ç¦»çº¿æ—¶è‡ªåŠ¨ç§¯ç´¯å¥–åŠ± (20%æ•ˆç‡ï¼Œ14å¤©ä¸Šé™)
2. **é‡Œç¨‹ç¢‘è¿½è¸ª** - 21ä¸ªé‡Œç¨‹ç¢‘ (å¢ƒç•Œ/ç­‰çº§/æ—¶é—´/æˆ˜æ–—)
3. **æ¯æ—¥æ´»åŠ¨è¿½è¸ª** - è¿ç»­ç™»å½•å¥–åŠ± (7/14/30/60/100/365/1000å¤©)
4. **å›å½’ç©å®¶åŠ é€Ÿ** - ç¦»çº¿ç©å®¶XPåŠ æˆ (æœ€é«˜3.0x)
5. **æ—¶é—´æ›²çº¿è®¡ç®—** - 1000å°æ—¶/1000å¤©è¿›åº¦å¯è§†åŒ–

**New Files Created:**
- `config/progression/offline_growth.yaml`
- `config/progression/milestones.yaml`
- `config/progression/time_curve.yaml`
- `src/progression/offline_growth.py`
- `src/progression/milestone.py`
- `src/progression/daily_activity.py`
- `src/progression/catch_up.py`
- `src/progression/time_curve.py`
- `src/web/offline_routes.py`
- `tests/test_progression_qa_pytest.py`
- `tests/test_daily_activity.py`

**Modified Files:**
- `src/models/player.py` - 11ä¸ªæ–°å­—æ®µ
- `src/web/simple_app.py` - ç™»å½•é›†æˆ

**API Endpoints:**
- `GET/POST /api/offline/rewards` - ç¦»çº¿å¥–åŠ±
- `GET/POST /api/offline/milestones` - é‡Œç¨‹ç¢‘
- `GET/POST /api/offline/streak` - è¿ç»­ç™»å½•
- `GET/POST /api/offline/catch-up` - å›å½’åŠ é€Ÿ
- `GET /api/offline/progress` - è¿›åº¦æŸ¥è¯¢

### âœ… è£…å¤‡æˆ˜æ–—é›†æˆ

**Status:** COMPLETED
**Implementation Date:** 2026-02-11

**Features Implemented:**
- è£…å¤‡å±æ€§åº”ç”¨åˆ°æˆ˜æ–—å®ä½“
- æˆ˜æ–—æ—¥å¿—æ˜¾ç¤ºè£…å¤‡å¢ç›Š
- ç¨€æœ‰åº¦å€ç‡ç³»ç»Ÿ

---

## ğŸ“‹ Next Steps (Recommended Priority)

1. **Issue #1: æµæ´¾æ•°æ®å¤–ç½®åˆ° YAML** - æ•°æ®é…ç½®åŒ–
2. **Issue #2: å®Œå–„é—¨æ´¾å…‹åˆ¶å…³ç³»** - 8x8å…‹åˆ¶çŸ©é˜µ
3. **Issue #4: æ•°æ®åº“å­˜å‚¨å±‚** - SQLiteæŒä¹…åŒ–
4. **Issue #7: æ·»åŠ æµ‹è¯•è¦†ç›–** - å•å…ƒæµ‹è¯•


