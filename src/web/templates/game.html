<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®ä»™æ–‡å­—MUD - æ¸¸æˆ</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ä¿®ä»™æ–‡å­—MUD</h1>
            <p class="subtitle">å‡¡äººä¿®ä»™ï¼Œé€†å¤©æ”¹å‘½</p>
        </header>

        <div class="game-container">
            <!-- å·¦ä¾§ï¼šè§’è‰²ä¿¡æ¯ -->
            <aside class="sidebar">
                <div class="card character-card">
                    <h2>è§’è‰²ä¿¡æ¯</h2>
                    <div id="character-info">
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>

                <div class="card stats-card">
                    <h2>å±æ€§</h2>
                    <div id="stats-info">
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </aside>

            <!-- ä¸­é—´ï¼šä¸»å†…å®¹åŒº -->
            <main class="main-content">
                <div class="card actions-card">
                    <h2>ä¿®ç‚¼è¡ŒåŠ¨</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="doCultivate()">
                            <span class="icon">ğŸ§˜</span>
                            æ‰“åä¿®ç‚¼
                        </button>
                        <button class="btn btn-success" onclick="doExplore()">
                            <span class="icon">ğŸ—ºï¸</span>
                            ç§˜å¢ƒæ¢ç´¢
                        </button>
                        <button class="btn btn-danger" onclick="doBattle()">
                            <span class="icon">âš”ï¸</span>
                            æŒ‘æˆ˜å¦–å…½
                        </button>
                        <button class="btn btn-info" onclick="viewQuests()">
                            <span class="icon">ğŸ“œ</span>
                            æŸ¥çœ‹ä»»åŠ¡
                        </button>
                    </div>
                </div>

                <div class="card log-card">
                    <h2>ä¿®ç‚¼æ—¥å¿—</h2>
                    <div id="game-log" class="log-content">
                        <p class="log-entry">æ¬¢è¿æ¥åˆ°ä¿®ä»™ä¸–ç•Œ...</p>
                    </div>
                </div>
            </main>
        </div>

        <footer class="footer">
            <p>ä¿®ä»™æ–‡å­—MUD v1.0 - å‡¡äººä¿®ä»™ï¼Œé€†å¤©æ”¹å‘½</p>
            <button onclick="logout()" style="margin-top: 10px; padding: 8px 16px; background: rgba(255,255,255,0.2); border: none; border-radius: 4px; color: #fff; cursor: pointer;">é€€å‡ºç™»å½•</button>
        </footer>
    </div>

    <script>
        let currentPlayer = null;

        window.onload = function() {
            checkLoginStatus();
        };

        function checkLoginStatus() {
            const playerName = localStorage.getItem('playerName');
            if (playerName) {
                loadPlayer(playerName);
            } else {
                window.location.href = '/login';
            }
        }

        function loadPlayer(name) {
            fetch('/api/player/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentPlayer = data.player;
                    updateCharacterInfo();
                    addLog(`æ¬¢è¿å›æ¥ï¼Œ${data.player.name}ï¼`);
                } else {
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addLog('åŠ è½½è§’è‰²æ•°æ®å¤±è´¥');
            });
        }

        function updateCharacterInfo() {
            if (!currentPlayer) return;

            const characterInfo = document.getElementById('character-info');
            const statsInfo = document.getElementById('stats-info');

            characterInfo.innerHTML = `
                <div class="info-item">
                    <span class="label">é“å·ï¼š</span>
                    <span class="value">${currentPlayer.name}</span>
                </div>
                <div class="info-item">
                    <span class="label">å¢ƒç•Œï¼š</span>
                    <span class="value stage">${currentPlayer.stage || 'ç‚¼æ°”æœŸ'}</span>
                </div>
                <div class="info-item">
                    <span class="label">ç­‰çº§ï¼š</span>
                    <span class="value">${currentPlayer.level || 1}</span>
                </div>
                <div class="info-item">
                    <span class="label">é—¨æ´¾ï¼š</span>
                    <span class="value">${currentPlayer.sect || 'é’äº‘é—¨'}</span>
                </div>
                <div class="info-item">
                    <span class="label">ä»™çŸ³ï¼š</span>
                    <span class="value stones">${currentPlayer.spirit_stones || 1000}</span>
                </div>
            `;

            statsInfo.innerHTML = `
                <div class="stat-bar">
                    <span class="stat-name">ç»éªŒï¼š</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(currentPlayer.xp || 0) % 100}%"></div>
                    </div>
                    <span class="stat-value">${currentPlayer.xp || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-name">æˆ˜æ–—åŠ›ï¼š</span>
                    <span class="stat-value power">${currentPlayer.combat_power || 100}</span>
                </div>
            `;
        }

        function doCultivate() {
            if (!currentPlayer) {
                addLog('è¯·å…ˆç™»å½•');
                return;
            }

            fetch('/api/action/cultivate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ hours: 1 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const cultivation = data.cultivation;
                    addLog(`ğŸ§˜ æ‰“åä¿®ç‚¼å®Œæˆï¼`);
                    addLog(`   è·å¾— ${cultivation.xp_gain} ç»éªŒ`);
                    addLog(`   è·å¾— ${cultivation.stones_gain} ä»™çŸ³`);
                    
                    if (cultivation.level_up) {
                        addLog(`â¬†ï¸ æ­å–œï¼ç­‰çº§æå‡åˆ° ${cultivation.new_level} çº§ï¼`);
                    }
                    
                    if (cultivation.stage_up) {
                        addLog(`ğŸ­ æ­å–œï¼çªç ´åˆ° ${cultivation.new_stage}ï¼`);
                    }
                    
                    loadPlayer(currentPlayer.name);
                } else {
                    addLog('ä¿®ç‚¼å¤±è´¥ï¼š' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addLog('ä¿®ç‚¼å¤±è´¥');
            });
        }

        function doExplore() {
            addLog('ğŸ—ºï¸  å¼€å§‹æ¢ç´¢ç§˜å¢ƒ...');
            addLog('   ä½ èµ°è¿›äº†ä¸€ç‰‡ç¥ç§˜çš„æ£®æ—...');
            
            const events = [
                { type: 'resource', message: 'å‘ç°äº†ä¸€äº›çµè‰', xp: 20, stones: 10 },
                { type: 'battle', message: 'é­é‡äº†é‡ç‹¼', xp: 50, stones: 30 },
                { type: 'treasure', message: 'å‘ç°äº†ä¸€ä¸ªå®ç®±', xp: 10, stones: 100 },
                { type: 'nothing', message: 'ä»€ä¹ˆéƒ½æ²¡å‘ç°', xp: 5, stones: 0 }
            ];
            
            const event = events[Math.floor(Math.random() * events.length)];
            
            setTimeout(() => {
                addLog(`   ${event.message}`);
                
                if (event.type === 'battle') {
                    addLog('   âš”ï¸  è¿›å…¥æˆ˜æ–—ï¼');
                    const win = Math.random() > 0.3;
                    if (win) {
                        addLog('   âœ… æˆ˜æ–—èƒœåˆ©ï¼');
                        addLog(`   è·å¾— ${event.xp} ç»éªŒ, ${event.stones} ä»™çŸ³`);
                    } else {
                        addLog('   âŒ æˆ˜æ–—å¤±è´¥ï¼');
                        addLog('   ä½ å—äº†è½»ä¼¤ï¼Œéœ€è¦ä¼‘æ¯...');
                    }
                } else {
                    addLog(`   è·å¾— ${event.xp} ç»éªŒ, ${event.stones} ä»™çŸ³`);
                }
                
                addLog('ğŸ—ºï¸  æ¢ç´¢ç»“æŸ');
            }, 1500);
        }

        function doBattle() {
            const enemies = ['é‡ç‹¼', 'å±±è´¼', 'å¦–ç‹', 'æ¯’è', 'é‡çŒª', 'æ¶éœ¸'];
            const enemy = enemies[Math.floor(Math.random() * enemies.length)];
            
            addLog(`âš”ï¸  é­é‡äº† ${enemy}ï¼`);
            addLog('   æˆ˜æ–—å¼€å§‹...');
            
            setTimeout(() => {
                const win = Math.random() > 0.4;
                if (win) {
                    const xpGain = 30 + Math.floor(Math.random() * 40);
                    const stoneGain = 10 + Math.floor(Math.random() * 30);
                    
                    addLog('   âœ… æˆ˜æ–—èƒœåˆ©ï¼');
                    addLog(`   è·å¾— ${xpGain} ç»éªŒ`);
                    addLog(`   è·å¾— ${stoneGain} ä»™çŸ³`);
                } else {
                    addLog('   âŒ æˆ˜æ–—å¤±è´¥ï¼');
                    addLog('   ä½ ç‹¼ç‹ˆåœ°é€ƒè·‘äº†...');
                }
            }, 2000);
        }

        function viewQuests() {
            addLog('ğŸ“œ ä»»åŠ¡åˆ—è¡¨ï¼š');
            addLog('');
            addLog('ğŸ“… æ—¥å¸¸ä»»åŠ¡ï¼š');
            addLog('  [ ] æ‰“åä¿®ç‚¼ 8 å°æ—¶');
            addLog('  [ ] å®Œæˆ 3 æ¬¡ç§˜å¢ƒæ¢ç´¢');
            addLog('  [ ] å‡»è´¥ 5 åªå¦–å…½');
            addLog('');
            addLog('ğŸ¯ ä¸»çº¿ä»»åŠ¡ï¼š');
            addLog('  [ ] è¾¾åˆ°ç‚¼æ°”æœŸ 10 çº§');
            addLog('  [ ] çªç ´åˆ°ç­‘åŸºæœŸ');
            addLog('  [ ] è¾¾åˆ°é‡‘ä¸¹æœŸ');
        }

        function addLog(message) {
            const logContent = document.getElementById('game-log');
            const entry = document.createElement('p');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function logout() {
            localStorage.removeItem('playerName');
            sessionStorage.clear();
            window.location.href = '/login';
        }
    </script>
</body>
</html>
